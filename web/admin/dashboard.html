<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UniversalShield Admin Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      color: #333;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 40px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 1.8rem;
      margin-bottom: 5px;
    }

    .header p {
      opacity: 0.9;
      font-size: 0.9rem;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .metric-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: transform 0.2s;
    }

    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .metric-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 5px;
    }

    .metric-label {
      color: #666;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-change {
      font-size: 0.85rem;
      margin-top: 8px;
    }

    .metric-change.positive {
      color: #4caf50;
    }

    .metric-change.negative {
      color: #f44336;
    }

    .section {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }

    .section h2 {
      font-size: 1.3rem;
      margin-bottom: 20px;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: #f5f7fa;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #555;
      border-bottom: 2px solid #e0e0e0;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
    }

    tr:hover {
      background: #f9f9f9;
    }

    .badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .badge.active {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .badge.inactive {
      background: #fff3e0;
      color: #e65100;
    }

    .badge.pro {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .badge.free {
      background: #f5f5f5;
      color: #666;
    }

    .badge.critical {
      background: #ffebee;
      color: #c62828;
    }

    .badge.caution {
      background: #fff3e0;
      color: #e65100;
    }

    .badge.safe {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .refresh-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .refresh-btn:hover {
      background: #5568d3;
      transform: scale(1.05);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .chart-container {
      height: 300px;
      margin-top: 20px;
    }

    .fraud-ring {
      background: #fff3e0;
      border-left: 4px solid #ff9800;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 4px;
    }

    .fraud-ring h4 {
      color: #e65100;
      margin-bottom: 8px;
    }

    .fraud-ring-meta {
      font-size: 0.85rem;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üõ°Ô∏è UniversalShield Admin Dashboard</h1>
    <p>Real-time fraud detection monitoring and analytics</p>
  </div>

  <div class="container">
    <div style="text-align: right; margin-bottom: 20px;">
      <button class="refresh-btn" onclick="loadDashboard()">üîÑ Refresh Data</button>
    </div>

    <!-- Key Metrics -->
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-value" id="totalScans">-</div>
        <div class="metric-label">Total Scans Today</div>
        <div class="metric-change positive" id="scansChange">-</div>
      </div>

      <div class="metric-card">
        <div class="metric-value" id="scamsDetected">-</div>
        <div class="metric-label">Scams Detected</div>
        <div class="metric-change" id="scamsChange">-</div>
      </div>

      <div class="metric-card">
        <div class="metric-value" id="activeLicenses">-</div>
        <div class="metric-label">Active Pro Licenses</div>
        <div class="metric-change positive" id="licensesChange">-</div>
      </div>

      <div class="metric-card">
        <div class="metric-value" id="fraudRings">-</div>
        <div class="metric-label">Active Fraud Rings</div>
        <div class="metric-change" id="ringsChange">-</div>
      </div>
    </div>

    <!-- Recent API Requests -->
    <div class="section">
      <h2>Recent API Requests</h2>
      <table>
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Endpoint</th>
            <th>Tier</th>
            <th>Risk Level</th>
            <th>Response Time</th>
          </tr>
        </thead>
        <tbody id="apiRequestsTable">
          <tr><td colspan="5" class="loading">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Active Licenses -->
    <div class="section">
      <h2>Active Licenses</h2>
      <table>
        <thead>
          <tr>
            <th>License Key</th>
            <th>Email</th>
            <th>Tier</th>
            <th>Scans Today</th>
            <th>Created</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="licensesTable">
          <tr><td colspan="6" class="loading">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Fraud Rings -->
    <div class="section">
      <h2>Detected Fraud Rings</h2>
      <div id="fraudRingsContainer">
        <div class="loading">Loading...</div>
      </div>
    </div>

    <!-- Model Performance -->
    <div class="section">
      <h2>ML Model Performance</h2>
      <table>
        <thead>
          <tr>
            <th>Version</th>
            <th>Type</th>
            <th>Accuracy</th>
            <th>Precision</th>
            <th>Recall</th>
            <th>F1 Score</th>
            <th>Trained</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="modelsTable">
          <tr><td colspan="8" class="loading">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const API_URL = 'https://api.tucan.store';

    async function loadDashboard() {
      await Promise.all([
        loadMetrics(),
        loadApiRequests(),
        loadLicenses(),
        loadFraudRings(),
        loadModels()
      ]);
    }

    async function loadMetrics() {
      try {
        // In production, create a dedicated admin endpoint
        // For now, we'll query the database directly via a new endpoint
        const response = await fetch(`${API_URL}/api/v1/admin/metrics`, {
          headers: { 'Authorization': 'Bearer admin_token' }
        });
        
        if (!response.ok) {
          // Fallback to mock data for demo
          document.getElementById('totalScans').textContent = '1,247';
          document.getElementById('scamsDetected').textContent = '89';
          document.getElementById('activeLicenses').textContent = '23';
          document.getElementById('fraudRings').textContent = '3';
          return;
        }

        const data = await response.json();
        document.getElementById('totalScans').textContent = data.total_scans.toLocaleString();
        document.getElementById('scamsDetected').textContent = data.scams_detected;
        document.getElementById('activeLicenses').textContent = data.active_licenses;
        document.getElementById('fraudRings').textContent = data.fraud_rings;
      } catch (error) {
        console.error('Metrics load error:', error);
      }
    }

    async function loadApiRequests() {
      const tbody = document.getElementById('apiRequestsTable');
      tbody.innerHTML = '<tr><td colspan="5" class="loading">Loading...</td></tr>';

      try {
        const response = await fetch(`${API_URL}/api/v1/admin/recent-requests`, {
          headers: { 'Authorization': 'Bearer admin_token' }
        });

        if (!response.ok) throw new Error('Failed to load');

        const requests = await response.json();
        
        tbody.innerHTML = requests.map(req => `
          <tr>
            <td>${new Date(req.timestamp).toLocaleString()}</td>
            <td>${req.endpoint}</td>
            <td><span class="badge ${req.tier}">${req.tier}</span></td>
            <td><span class="badge ${req.risk_level}">${req.risk_level || 'N/A'}</span></td>
            <td>${req.response_time_ms}ms</td>
          </tr>
        `).join('');
      } catch (error) {
        tbody.innerHTML = '<tr><td colspan="5">Failed to load data</td></tr>';
      }
    }

    async function loadLicenses() {
      const tbody = document.getElementById('licensesTable');
      tbody.innerHTML = '<tr><td colspan="6" class="loading">Loading...</td></tr>';

      try {
        const response = await fetch(`${API_URL}/api/v1/admin/licenses`, {
          headers: { 'Authorization': 'Bearer admin_token' }
        });

        if (!response.ok) throw new Error('Failed to load');

        const licenses = await response.json();
        
        tbody.innerHTML = licenses.map(lic => `
          <tr>
            <td><code>${lic.license_key}</code></td>
            <td>${lic.email}</td>
            <td><span class="badge ${lic.tier}">${lic.tier}</span></td>
            <td>${lic.scans_used_today || 0}</td>
            <td>${new Date(lic.created_at).toLocaleDateString()}</td>
            <td><span class="badge ${lic.active ? 'active' : 'inactive'}">${lic.active ? 'Active' : 'Inactive'}</span></td>
          </tr>
        `).join('');
      } catch (error) {
        tbody.innerHTML = '<tr><td colspan="6">Failed to load data</td></tr>';
      }
    }

    async function loadFraudRings() {
      const container = document.getElementById('fraudRingsContainer');
      container.innerHTML = '<div class="loading">Loading...</div>';

      try {
        const response = await fetch(`${API_URL}/api/v1/admin/fraud-rings`, {
          headers: { 'Authorization': 'Bearer admin_token' }
        });

        if (!response.ok) throw new Error('Failed to load');

        const rings = await response.json();
        
        if (rings.length === 0) {
          container.innerHTML = '<p style="color: #999;">No active fraud rings detected</p>';
          return;
        }

        container.innerHTML = rings.map(ring => `
          <div class="fraud-ring">
            <h4>üî¥ Fraud Ring: ${ring.ring_identifier}</h4>
            <div class="fraud-ring-meta">
              <strong>Members:</strong> ${ring.member_count} | 
              <strong>Pattern:</strong> ${ring.pattern_type} | 
              <strong>Confidence:</strong> ${(ring.confidence_score * 100).toFixed(1)}% | 
              <strong>Detected:</strong> ${new Date(ring.detected_at).toLocaleDateString()}
            </div>
          </div>
        `).join('');
      } catch (error) {
        container.innerHTML = '<p>Failed to load fraud rings</p>';
      }
    }

    async function loadModels() {
      const tbody = document.getElementById('modelsTable');
      tbody.innerHTML = '<tr><td colspan="8" class="loading">Loading...</td></tr>';

      try {
        const response = await fetch(`${API_URL}/api/v1/admin/models`, {
          headers: { 'Authorization': 'Bearer admin_token' }
        });

        if (!response.ok) throw new Error('Failed to load');

        const models = await response.json();
        
        tbody.innerHTML = models.map(model => `
          <tr>
            <td><code>${model.version}</code></td>
            <td>${model.model_type}</td>
            <td>${(model.accuracy * 100).toFixed(1)}%</td>
            <td>${(model.precision_score * 100).toFixed(1)}%</td>
            <td>${(model.recall * 100).toFixed(1)}%</td>
            <td>${(model.f1_score * 100).toFixed(1)}%</td>
            <td>${new Date(model.trained_at).toLocaleDateString()}</td>
            <td><span class="badge ${model.is_active ? 'active' : 'inactive'}">${model.is_active ? 'Active' : 'Inactive'}</span></td>
          </tr>
        `).join('');
      } catch (error) {
        tbody.innerHTML = '<tr><td colspan="8">Failed to load data</td></tr>';
      }
    }

    // Load dashboard on page load
    loadDashboard();

    // Auto-refresh every 30 seconds
    setInterval(loadDashboard, 30000);
  </script>
</body>
</html>
